name: Market Scanner

on:
  schedule:
    - cron: '0 11 * * 1-5'   # scan-fast    — 16:30 IST Mon–Fri  (daily open)
    - cron: '30 15 * * 1,5'  # scan-full    — 21:00 IST Mon & Fri (weekly deep dive)
    - cron: '0 17 * * 1-5'   # scan-monitor — 22:30 IST Mon–Fri  (daily close)
    - cron: '30 15 * * 5'    # weekly-report — 21:00 IST Friday
  workflow_dispatch:
    inputs:
      mode:
        description: 'Which job to run'
        required: true
        default: 'fast'
        type: choice
        options:
          - fast
          - full
          - monitor
          - weekly-report

# ── Daily Open — Fast Scan (16:30 IST / 11:00 UTC) ───────────────────────────
jobs:
  scan-fast:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: >
      (github.event_name == 'schedule' && github.event.schedule == '0 11 * * 1-5') ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.mode == 'fast')
    permissions:
      contents: write

    env:
      ANTHROPIC_API_KEY:     ${{ secrets.ANTHROPIC_API_KEY }}
      TELEGRAM_BOT_TOKEN:    ${{ secrets.TELEGRAM_BOT_TOKEN }}
      TELEGRAM_CHAT_ID:      ${{ secrets.TELEGRAM_CHAT_ID }}
      POLYGON_API_KEY:       ${{ secrets.POLYGON_API_KEY }}
      ALPHA_VANTAGE_API_KEY: ${{ secrets.ALPHA_VANTAGE_API_KEY }}
      FINNHUB_API_KEY:       ${{ secrets.FINNHUB_API_KEY }}
      STREAMLIT_URL:         ${{ secrets.STREAMLIT_URL }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      - run: npm ci
      - run: mkdir -p logs
      - run: npm run scan -- --mode=fast

      - name: Commit updated results
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add OPPORTUNITIES.md logs/ 2>/dev/null || true

          if git diff --cached --quiet; then
            echo "No changes to commit."
          else
            git commit -m "chore: fast scan $(date -u +'%Y-%m-%d %H:%M')"
            git pull --rebase origin main
            git push
          fi

# ── Weekly Deep Dive — Full Scan (21:00 IST Mon & Fri / 15:30 UTC) ───────────
  scan-full:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    if: >
      (github.event_name == 'schedule' && github.event.schedule == '30 15 * * 1,5') ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.mode == 'full')
    permissions:
      contents: write

    env:
      ANTHROPIC_API_KEY:     ${{ secrets.ANTHROPIC_API_KEY }}
      TELEGRAM_BOT_TOKEN:    ${{ secrets.TELEGRAM_BOT_TOKEN }}
      TELEGRAM_CHAT_ID:      ${{ secrets.TELEGRAM_CHAT_ID }}
      POLYGON_API_KEY:       ${{ secrets.POLYGON_API_KEY }}
      ALPHA_VANTAGE_API_KEY: ${{ secrets.ALPHA_VANTAGE_API_KEY }}
      FINNHUB_API_KEY:       ${{ secrets.FINNHUB_API_KEY }}
      STREAMLIT_URL:         ${{ secrets.STREAMLIT_URL }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      - run: npm ci
      - run: mkdir -p logs
      - run: npm run scan -- --mode=full

      - name: Commit updated results
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add OPPORTUNITIES.md logs/ 2>/dev/null || true

          if git diff --cached --quiet; then
            echo "No changes to commit."
          else
            git commit -m "chore: full scan $(date -u +'%Y-%m-%d')"
            git pull --rebase origin main
            git push
          fi

# ── Daily Close — Monitor Scan (22:30 IST / 17:00 UTC) ───────────────────────
  scan-monitor:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    if: >
      (github.event_name == 'schedule' && github.event.schedule == '0 17 * * 1-5') ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.mode == 'monitor')
    permissions:
      contents: write

    env:
      ANTHROPIC_API_KEY:     ${{ secrets.ANTHROPIC_API_KEY }}
      TELEGRAM_BOT_TOKEN:    ${{ secrets.TELEGRAM_BOT_TOKEN }}
      TELEGRAM_CHAT_ID:      ${{ secrets.TELEGRAM_CHAT_ID }}
      POLYGON_API_KEY:       ${{ secrets.POLYGON_API_KEY }}
      ALPHA_VANTAGE_API_KEY: ${{ secrets.ALPHA_VANTAGE_API_KEY }}
      FINNHUB_API_KEY:       ${{ secrets.FINNHUB_API_KEY }}
      STREAMLIT_URL:         ${{ secrets.STREAMLIT_URL }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      - run: npm ci
      - run: mkdir -p logs
      - run: npm run scan -- --mode=monitor

      - name: Commit updated results
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add OPPORTUNITIES.md logs/ 2>/dev/null || true

          if git diff --cached --quiet; then
            echo "No changes to commit."
          else
            git commit -m "chore: monitor scan $(date -u +'%Y-%m-%d %H:%M')"
            git pull --rebase origin main
            git push
          fi

# ── Weekly Report (Friday 21:00 IST / 15:30 UTC) ─────────────────────────────
  weekly-report:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: >
      (github.event_name == 'schedule' && github.event.schedule == '30 15 * * 5') ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.mode == 'weekly-report')

    env:
      TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
      TELEGRAM_CHAT_ID:   ${{ secrets.TELEGRAM_CHAT_ID }}

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 22
      - run: npm ci
      - run: mkdir -p logs
      - run: npm run weekly-report
